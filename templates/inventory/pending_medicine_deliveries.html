{% extends 'base.html' %}
{% block content %}


<h2>Pending Medicine Deliveries</h2>
<table class="table">
    <thead>
        <tr>
            <th>Invoice ID</th>
            <th>Patient Name</th>
            <th>Patient Type</th>
             <th>Patient ID</th>
            <th>Total Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>

   {% for invoice, medicine_total in invoice_data %}
        <tr>
             <td>{{ invoice.invoice_id }}</td>
            <td>{{ invoice.patient.name }}</td>
              <td>{{ invoice.invoice_type }}</td>
              <td>{{ invoice.patient.patient_id }}</td>
            <td>৳{{ medicine_total|floatformat:2 }}</td>
            <td>
                <!-- Button to trigger modal -->
                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#invoiceModal{{ invoice.id }}">
                    View
                </button>
                <a href="{% url 'inventory:deliver_invoice_medicines' invoice.id %}" class="btn btn-primary btn-sm">Deliver</a>
            </td>
        </tr>

        <!-- Modal -->
        <div class="modal fade" id="invoiceModal{{ invoice.id }}" tabindex="-1" aria-labelledby="modalLabel{{ invoice.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalLabel{{ invoice.id }}">Invoice #{{ invoice.invoice_id }}<br>
                    </h5><h5 class="text-center"> Medicine Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <p><strong>Patient name:</strong> {{ invoice.patient.name }}
                    <strong>Patient UID:</strong> {{ invoice.patient.patient_id }}
                </p>
                 <p>
                    <strong>Doctor:</strong>
                    {% if invoice.medicine_only_invoices %}
                        {% if invoice.medicine_only_invoices.doctor %}
                            {{ invoice.medicine_only_invoices.doctor.name }}
                        {% elif invoice.medicine_only_invoices.doctor_ref %}
                            {{ invoice.medicine_only_invoices.doctor_ref }}
                        {% endif %}
                    {% elif invoice.medicalrecord and invoice.medicalrecord.doctor %}
                        {{ invoice.medicalrecord.doctor.name }}
                    {% elif invoice.appointment and invoice.appointment.doctor %}
                        {{ invoice.appointment.doctor.name }}
                    {% elif invoice.admission and invoice.admission.doctor %}
                        {{ invoice.admission.doctor.name }}
                    {% else %}
                        Not Assigned
                    {% endif %}
                    </p>

                  <p><strong>Source:</strong> {{ invoice.medicine_bills.first.patient_type }}</p>

                  <h5>Medicines:</h5>
                  <ul>
                      {% for med in invoice.medicine_bills.all %}
                          <li>{{ med.medicine.name }} — Qty: {{ med.quantity }} @ {{ med.price_per_unit }}</li>
                      {% endfor %}
                  </ul>

                  <p><strong>Total:</strong> ৳{{ medicine_total|floatformat:2 }}</p>
              </div>
              <div class="modal-footer">
                <a href="{% url 'inventory:deliver_invoice_medicines' invoice.id %}" class="btn btn-success">Deliver Now</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
         {% empty %}
        <tr>
            <td colspan="4" class="text-center text-muted">No pending medicine deliveries found.</td>
        </tr>

    {% endfor %}
    </tbody>
</table>
{% endblock %}
