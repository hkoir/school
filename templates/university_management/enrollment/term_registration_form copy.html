{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Term Registration{% endblock %}

{% block content %}
{% include 'university_management/quick_access_link.html' %}
<div class="container">

    <h2 class="my-4">ðŸ“˜ Term Registration</h2>

    {% if term_form.non_field_errors %}
        <div class="alert alert-danger">
            {{ term_form.non_field_errors }}
        </div>
    {% endif %}

    <form method="post" id="term-registration-form" novalidate>
        {% csrf_token %}

       <!-- Term Header -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">
                Student Term Information
            </div>

            <div class="card-body">

                <div class="row g-3">
                   
                    <div class="col-md-6">
                        <label class="form-label">{{ term_form.level.label }}</label>
                        {{ term_form.level|add_class:'form-control' }}
                        <div class="text-danger small">{{ term_form.level.errors }}</div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{{ term_form.term.label }}</label>
                        {{ term_form.term|add_class:'form-control'  }}
                        <div class="text-danger small">{{ term_form.term.errors }}</div>
                    </div>              
                         

              </div>

            </div>
        </div>

        {{ formset.management_form }}

        {% if formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ formset.non_form_errors }}
            </div>
        {% endif %}

        <!-- Subject Enrollment -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">
                Subject Enrollment
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="subject-table"
                           class="table table-bordered table-sm mb-0 align-middle">
                        <thead class="table-secondary">
                            <tr>
                                <th style="width:70%">Subject</th>
                                <th style="width:30%" class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in formset %}
                                <tr class="form-row">
                                    <td>
                                        {{ f.subject_offering|add_class:'form-control'  }}
                                        <div class="text-danger small">
                                            {{ f.subject_offering.errors }}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {{ f.DELETE }}
                                        <button type="button"
                                                class="remove-row btn btn-outline-danger btn-sm">
                                            <i class="fas fa-trash-alt"></i> Remove
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="d-flex justify-content-between">
            <button type="button" id="add-row" class="btn btn-outline-secondary">
                <i class="fas fa-plus"></i> Add Subject
            </button>

            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Register Term
            </button>
        </div>

    </form>
</div>

<!-- Empty form template -->
<table style="display:none">
    <tbody id="empty-form">
        <tr class="form-row">
            <td>{{ formset.empty_form.subject_offering|add_class:'form-control'  }}</td>
            <td class="text-center">
                {{ formset.empty_form.DELETE }}
                <button type="button"
                        class="remove-row btn btn-outline-danger btn-sm">
                    <i class="fas fa-trash-alt"></i> Remove
                </button>
            </td>
        </tr>
    </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const prefix = "{{ formset.prefix }}";
    const totalForms = document.getElementById("id_" + prefix + "-TOTAL_FORMS");
    const tableBody = document.querySelector("#subject-table tbody");
    const emptyRowTemplate = document.querySelector("#empty-form").innerHTML;
    const addBtn = document.getElementById("add-row");

    addBtn.addEventListener("click", function () {
        const index = parseInt(totalForms.value, 10);
        const newRowHtml = emptyRowTemplate.replace(/__prefix__/g, index);
        tableBody.insertAdjacentHTML("beforeend", newRowHtml);
        totalForms.value = index + 1;
    });

    tableBody.addEventListener("click", function (e) {
        if (e.target.closest(".remove-row")) {
            const tr = e.target.closest("tr");
            const delInput = tr.querySelector("input[name$='-DELETE']");

            if (delInput) {
                delInput.checked = true;
                tr.style.display = "none";
            } else {
                tr.remove();
                totalForms.value = parseInt(totalForms.value, 10) - 1;
            }
        }
    });
});
</script>

{% endblock %}
