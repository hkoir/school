{% extends "base.html" %}
{% load static %}

{% block content %}

{% include 'university_management/quick_access_link.html' %}

<div class="container-fluid my-4">
    <h1 class="text-center">Revenue Dashboard</h1>

   <!-- Academic Year Filter -->
    <div class="d-flex justify-content-center mb-4">
        <form id="yearFilterForm" method="get" class="d-flex align-items-center gap-2">
            <label for="academicYearSelect" class="fw-semibold mb-0">Academic Year:</label>
            <select id="academicYearSelect" name="academic_year" class="form-select w-auto">
                <option value="">-- All Years --</option>
                {% for year in academic_years %}
                    <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                {% endfor %}
            </select>
        </form>
    </div>


    <!-- Session-wise Revenue Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Session-wise Revenue</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Academic Session</th>
                            <th class="text-end">Total Payable</th>
                            <th class="text-end">Total Paid</th>
                            <th class="text-end">Due</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in session_revenue %}
                        <tr>
                            <td>{{ row.academic_session__name }}</td>
                            <td class="text-end">{{ row.total_payable|floatformat:2 }}</td>
                            <td class="text-end fw-semibold">{{ row.total_paid|floatformat:2 }}</td>
                            <td class="text-end text-danger">{{ row.total_due|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center">No data</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Program-wise Bar Chart -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Program-wise Revenue</h5>
            <div class="row" style="overflow-x:auto">
             <div style="overflow-x:auto; margin: auto">
                <canvas id="programRevenueChart"></canvas>
            </div>
            </div>
        </div>
    </div>

    <!-- Term-wise Pie Charts per Program -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Term-wise Revenue</h5>
            <div class="row" style="overflow-x:auto">             
                <div class="d-flex flex-wrap gap-4 overflow-auto" id="termPieContainer"></div>           
            </div>
        </div>
    </div>

</div>


<script>
    // Auto-submit year
    document.getElementById('academicYearSelect')
        .addEventListener('change', () => document.getElementById('yearFilterForm').submit());

    // Parse JSON from Django context
    const programData = JSON.parse('{{ program_chart_json|escapejs }}');
    const termProgramData = JSON.parse('{{ term_program_json|escapejs }}');

    // Program Bar Chart
    new Chart(document.getElementById('programRevenueChart'), {
        type: 'bar',
        data: {
            labels: programData.labels,
            datasets: [{
                label: 'Revenue',
                data: programData.data,
                backgroundColor: [
                    '#4e79a7','#f28e2c','#e15759','#76b7b2',
                    '#59a14f','#edc949','#af7aa1','#ff9da7',
                    '#9c755f','#bab0ab'
                ]
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    // Term-wise Pie Charts per Program
    const termPieContainer = document.getElementById('termPieContainer');
    termProgramData.forEach((dataset, idx) => {
        const div = document.createElement('div');
        div.style.minWidth = '250px';
        div.style.maxWidth = '350px';
        div.classList.add('mb-3');

        const title = document.createElement('h6');
        title.classList.add('text-center');
        title.innerText = dataset.program;
        div.appendChild(title);

        const canvas = document.createElement('canvas');
        canvas.id = `termPieChart${idx+1}`;
        canvas.height = 220;
        div.appendChild(canvas);
        termPieContainer.appendChild(div);

        new Chart(canvas, {
            type: 'pie',
            data: {
                labels: dataset.labels,
                datasets: [{
                    label: dataset.program,
                    data: dataset.data,
                    backgroundColor: [
                        '#4e79a7','#f28e2c','#e15759','#76b7b2',
                        '#59a14f','#edc949','#af7aa1','#ff9da7',
                        '#9c755f','#bab0ab'
                    ]
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
    });
</script>
{% endblock %}
